---
layout: post
title: Rspec tricks for DRY mocked specs
date: '2016-02-15T21:27:00.000-08:00'
author: Mark J. Lehman
tags:
- rspec
- dry
modified_time: '2016-01-24T21:28:59.402-08:00'
blogger_id: tag:blogger.com,1999:blog-4459370175540830177.post-3036803349844227194
blogger_orig_url: http://spaghettirefactory.blogspot.com/2016/02/rspec-tricks-for-dry-mocked-specs.html
---

These “tricks” are <a href="https://www.relishapp.com/rspec/rspec-core/docs/example-groups/shared-context">straight from</a> <a href="https://www.relishapp.com/rspec/rspec-rails/docs/controller-specs/anonymous-controller">the docs</a>. One will help DRY up your specs, the other will help you mock your controller for controller tests.<br /><h3><a href="https://draft.blogger.com/null" id="Shared_Contexts_4"></a>Shared Contexts</h3>Shared context allows for extracting certain setup steps and sharing them across several different sets of tests.<br /><br />First, define your shared context:<br /><pre><code><br /></code></pre><pre><code>RSpec.shared_context "user setup" <span class="hljs-operator"><span class="hljs-keyword">do</span><br />  let(:<span class="hljs-keyword">user</span>) { <span class="hljs-keyword">User</span>.<span class="hljs-keyword">new</span>(<span class="hljs-keyword">name</span>: <span class="hljs-string">'Chuck Norris'</span>) }<br />  <span class="hljs-keyword">before</span> { <span class="hljs-keyword">allow</span>(<span class="hljs-keyword">user</span>).<span class="hljs-keyword">to</span> receive(:some_method) }<br /><span class="hljs-keyword">end</span><br /></span></code></pre><br />Then, include it in your spec files:<br /><pre><code><br /></code></pre><pre><code>describe UsersController <span class="hljs-built_in">do</span><br />  include_context <span class="hljs-string">'user setup'</span><br />  <br />  <span class="hljs-comment"># Tests go here...</span><br /><span class="hljs-function"><span class="hljs-keyword">end</span><br /></span></code></pre><h3><a href="https://draft.blogger.com/null" id="Anonymous_Controllers_25"></a>Anonymous Controllers</h3>Anonymous controllers are a way to specify certain behavior for the controller you are trying to test, or more likely for a parent controller. The thing I found it most useful for, and not coincidentally the thing that the docs says it is useful for, is testing global error handling.<br /><pre><code><span class="hljs-operator"><span class="hljs-keyword"><br /></span></span></code></pre><pre><code><span class="hljs-operator"><span class="hljs-keyword">describe</span> UsersController <span class="hljs-keyword">do</span><br />  controller <span class="hljs-keyword">do</span><br />    <span class="hljs-keyword">def</span> <span class="hljs-keyword">index</span><br />      <span class="hljs-keyword">raise</span> AccessDenied<br />    <span class="hljs-keyword">end</span><br />  <span class="hljs-keyword">end</span><br /><br />  subject { <span class="hljs-keyword">get</span> :<span class="hljs-keyword">index</span> }<br /><br />  <span class="hljs-keyword">describe</span> <span class="hljs-string">"handling AccessDenied exceptions"</span> <span class="hljs-keyword">do</span><br />    it <span class="hljs-string">"redirects to the /401.html page"</span> <span class="hljs-keyword">do</span><br />      expect(subject).<span class="hljs-keyword">to</span> redirect_to(<span class="hljs-string">"/401.html"</span>)<br />    <span class="hljs-keyword">end</span><br />  <span class="hljs-keyword">end</span><br /><span class="hljs-keyword">end</span><br /></span></code></pre>