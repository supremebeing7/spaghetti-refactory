---
layout: post
title: "'Publishing' an object and associations using serialized fields"
date: '2015-01-15T22:37:00.000-08:00'
author: Mark J. Lehman
tags:
- ruby
modified_time: '2015-08-21T10:06:46.707-07:00'
blogger_id: tag:blogger.com,1999:blog-4459370175540830177.post-1755809509110591888
blogger_orig_url: http://spaghettirefactory.blogspot.com/2015/03/publishing-object-and-associations.html
---

This is one I'm pretty proud of. It's certainly not perfect, and we'll see how future proof it is, but I think with the problem I was trying to solve, it came out as a fairly elegant solution.<br /><br />On our project, we had, ironically, a Project model that had all kinds of has_many associations on it. We needed a user to be able to "publish" their project and it would essentially take a snapshot of the project object and all association data at that time, and be able to server it in JSON for API calls.  <br /><br />I made a PublishedVersions polymorphic model with a publishable_id and publishable_type, and a serialized `details` field so it can just hold a JSON hash in the right format.   <br /><pre><code><br />class PublishedVersion &lt; ActiveRecord::Base<br />  serialize :details<br />  belongs_to :publishable, polymorphic: true<br />end<br /></code></pre><br />Then, when the user publishes an project, in whatever action that form goes to (:publish or :update, probably), we run<br /><br />&nbsp; <code>object_details = JSON.parse render_to_string(partial: 'api/projects/detail.json.jbuilder')</code><br /><br />to render the proper project detail response as JSON.<br /><br />After that, we persist that response right into the details field of the PublishedVersion object.  <br /><code><br /></code><code>PublishedVersion.create(publishable_type: ‘Project’, publishable_id: project.id, details: published_details)</code><br /><br />Our Project class gets a <code>has_many :published_versions, as: :publishable</code> relation. This way, there is a history of published versions which user can view as snapshots.  <br /><br />If they really screw up the work-in-progress version of Project, they could revert to a previous version potentially, although this kind of functionality would be better handled by using something like paper_trail.<br /><br />(The reverting process would have to be built as a separate method or class even, and it would have to find a published version by timestamp or id, and create or update all of the instances and associations. Nonetheless, the data would be in the database, so it's completely doable.) <br /><br />For API calls to get the published version, since it’s already in JSON format, we don’t even need to render a jbuilder, we can simply run:<br /><code><br /></code><code>render json: object.published_versions.last.details</code><br /><br />I made a helper method for this, #most_recent_published_version, that calls the same code.