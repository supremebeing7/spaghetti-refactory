---
layout: post
title: Asynchronous processing pitfalls and ActiveRecord locking
date: '2015-09-28T09:49:00.000-07:00'
author: Mark J. Lehman
tags:
- rails
- ruby
- asynchronous
- activerecord
- sidekiq
- sql
modified_time: '2015-10-30T09:50:16.931-07:00'
blogger_id: tag:blogger.com,1999:blog-4459370175540830177.post-2535019213541753894
blogger_orig_url: http://spaghettirefactory.blogspot.com/2015/10/asynchronous-processing-pitfalls-and.html
---

My app is humming along, but there are a few sections that have to do a lot of heavy lifting, whether that be image processing, updating several different related objects, or looping through all of a has_many association to manipulate every record. <br /><br />These types of things are perfect places to push some logic to a background process. In other words, make it asynchronous. So, if a user clicks a button to update several objects, unless the user needs to see those updates completed immediately, then a tool like <a href="https://github.com/mperham/sidekiq">Sidekiq</a> can help run some expensive logic as a background process and allow the user to continue surfing the site while that process runs.<br /><br />There are plenty of <a href="http://railscasts.com/episodes/366-sidekiq">tutorials</a> about how to set this up, so that’s not what I want to talk about here.<br /><br />One of the potential pitfalls of processing things asynchronously, particularly if the processing involves updating database records, is multiple records being updated at the same time. For example, one user updates a Project in a background process, and another user updates the same Project somewhere else in the app that doesn’t use a background process. We want to last update to be the one that sticks, but if both updates are happening at the same time, things could get hairy.<br /><br />This is the dreaded “race conditions” issue, and luckily there’s a pretty simple fix.<br /><br />On ActiveRecord - and I believe this will work with any SQL database but definitely at least on Postgres and MySQL - I can lock a specific row while editing, then unlock it afterwards, so that each edit takes place in its own little bubble.<br /><br /><pre><code>Account.transaction do<br />  acc = Account.lock.find(id)<br />  acc.balance -= 25<br />  acc.save!<br />end<br /></code></pre><pre><code><br /></code></pre>This finds an account and locks it, then updates the balance, saves, and unlocks.<br /><br />This is really important when dealing with numbers, money, and balances. Let me share a parable to explain:<br /><br />There is an Account with <script id="MathJax-Element-24" type="math/tex">100 balance.   One user in that account makes a transaction for </script>75.<br /><br />A split second later, another user in that account makes a transaction for $90.<br /><br />What should happen is the second user’s transaction should be rejected for lack of funds.<br /><br />What actually happens without locking is that for each transaction, the first step is that the server runs <code>account = Account.find(id)</code> to retrieve the account, and since this is happening before either transaction has finished, the balance on the account in both cases is <script id="MathJax-Element-25" type="math/tex">100. So, after the first user's transaction, the balance is updated to </script>25 and the account is saved. But on the second user’s transaction, the account object that was pulled from the database still shows a balance of <script id="MathJax-Element-26" type="math/tex">100, so the server deducts the </script>90 charge from the balance and saves it, thereby allowing the transaction to go through and setting the saved account balance as $10.<br /><br />Is your head spinning yet? <br /><br />When we lock the account per transaction, we avoid this issue by only allowing the account to be edited on transaction at a time.<br /><br />It’s a cool concept but also can be tricky to wrap your head around. <a href="http://www.leighhalliday.com/avoid-race-conditions-with-postgres-locks">Here’s a blog post</a> I borrowed heavily from for my post. Or check out the <a href="http://api.rubyonrails.org/classes/ActiveRecord/Locking/Pessimistic.html">Rails API docs</a>.